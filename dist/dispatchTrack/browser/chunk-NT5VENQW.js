import{Q as u,a as c,b as a,i as l,m as r}from"./chunk-MSHVY7YR.js";var d=class o{socket=null;stompClient=null;reconnectAttempts=0;maxReconnectAttempts=5;reconnectInterval=3e3;notificationsSubject=new r([]);notifications$=this.notificationsSubject.asObservable();connectionStatusSubject=new r("disconnected");connectionStatus$=this.connectionStatusSubject.asObservable();constructor(){this.loadSockJSAndSTOMP()}loadSockJSAndSTOMP(){if(!window.SockJS){let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js",document.head.appendChild(t)}if(!window.Stomp){let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js",document.head.appendChild(t)}}connect(t){if(this.stompClient&&this.stompClient.connected){console.log("STOMP client already connected");return}this.connectionStatusSubject.next("connecting");try{setTimeout(()=>{this.initializeSTOMPConnection(t)},1e3)}catch(e){console.error("Failed to create STOMP connection:",e),this.connectionStatusSubject.next("disconnected")}}initializeSTOMPConnection(t){let e=window.SockJS,i=window.Stomp;if(!e||!i){console.error("SockJS or STOMP not loaded"),this.connectionStatusSubject.next("disconnected");return}console.log("Attempting to connect to SockJS endpoint..."),this.socket=new e("http://localhost:8087/ws"),this.stompClient=i.over(this.socket),this.stompClient.debug=null,this.stompClient.connect({},n=>{console.log("STOMP connected successfully:",n),this.connectionStatusSubject.next("connected"),this.reconnectAttempts=0,this.subscribeToUserNotifications(t)},n=>{console.error("STOMP connection error:",n),this.connectionStatusSubject.next("disconnected"),this.reconnectAttempts<this.maxReconnectAttempts&&this.attemptReconnect(t)})}subscribeToUserNotifications(t){if(!this.stompClient||!this.stompClient.connected){console.error("STOMP client not connected");return}console.log("Subscribing to notifications for user:",t),[`/user/${t}/queue/notifications`,`/user/${t}/queue/driver`,`/user/${t}/queue/updates`,`/user/${t}/queue/tracking`,`/user/${t}/queue/payments`].forEach(i=>{this.stompClient.subscribe(i,n=>{console.log("Received message from",i,":",n.body);try{let s=JSON.parse(n.body);this.handleIncomingMessage(s)}catch(s){console.error("Error parsing message:",s),this.handleIncomingMessage({message:n.body})}})}),this.stompClient.subscribe("/topic/driver-notifications",i=>{console.log("Received driver notification:",i.body);try{let n=JSON.parse(i.body);this.handleIncomingMessage(n)}catch{this.handleIncomingMessage({message:i.body})}}),console.log("All subscriptions created successfully")}handleIncomingMessage(t){console.log("Processing WebSocket message:",t);let e={id:this.generateNotificationId(),title:this.extractTitle(t),message:this.extractMessage(t),type:this.determineNotificationType(t),timestamp:new Date,read:!1};console.log("Created notification:",e);let i=this.notificationsSubject.value;this.notificationsSubject.next([e,...i]),this.showBrowserNotification(e)}extractTitle(t){return t.title?t.title:t.type?t.type:"New Notification"}extractMessage(t){return t.message?t.message:t.content?t.content:typeof t=="string"?t:"You have a new notification"}determineNotificationType(t){if(t.type)switch(t.type.toLowerCase()){case"success":return"success";case"error":return"error";case"warning":return"warning";default:return"info"}let e=this.extractMessage(t).toLowerCase();return e.includes("accepted")||e.includes("success")?"success":e.includes("error")||e.includes("failed")?"error":e.includes("warning")||e.includes("pending")?"warning":"info"}showBrowserNotification(t){"Notification"in window&&Notification.permission==="granted"&&new Notification(t.title,{body:t.message,icon:"/assets/icon-192x192.png",badge:"/assets/icon-192x192.png",tag:t.id})}generateNotificationId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}attemptReconnect(t){this.reconnectAttempts++,console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),setTimeout(()=>{this.connect(t)},this.reconnectInterval)}disconnect(){this.stompClient&&(this.stompClient.disconnect(),this.stompClient=null),this.socket&&(this.socket.close(),this.socket=null),this.connectionStatusSubject.next("disconnected")}testConnection(){console.log("Testing STOMP WebSocket connection..."),this.connect("test-user")}testNotification(t){console.log("Testing notification for user:",t);let e={userId:t,message:`Test notification for user ${t} at ${new Date().toLocaleTimeString()}`,title:"Test Notification",path:"/queue/notifications"},i=localStorage.getItem("authToken");fetch("http://localhost:8087/api/notifications/user/custom",{method:"POST",headers:c({"Content-Type":"application/json"},i?{Authorization:`Bearer ${i}`}:{}),body:JSON.stringify(e)}).then(n=>{console.log("Test notification response:",n.status),n.ok?console.log("\u2705 Test notification sent successfully"):console.error("\u274C Test notification failed")}).catch(n=>{console.error("\u274C Test notification error:",n)})}getCurrentUserId(){let t=localStorage.getItem("userId");return console.log("Current user ID from localStorage:",t),t}getConnectionStatus(){return this.connectionStatusSubject.value}requestNotificationPermission(){return"Notification"in window?Notification.requestPermission().then(t=>t==="granted"):Promise.resolve(!1)}markAsRead(t){let i=this.notificationsSubject.value.map(n=>n.id===t?a(c({},n),{read:!0}):n);this.notificationsSubject.next(i)}clearAllNotifications(){this.notificationsSubject.next([])}getUnreadCount(){return new l(t=>{this.notifications$.subscribe(e=>{let i=e.filter(n=>!n.read).length;t.next(i)})})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{d as a};
